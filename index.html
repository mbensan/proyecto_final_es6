<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      .modal img {
        display: inline-block;
        border-radius: 10px;
      }
      option[value="actual"] {
        font-style: italic;
      }1q <cx|
    </style>
  </head>

  <body>
    <nav>
      <div class="nav-wrapper">
        <a href="#" class="brand-logo">Ninja Car Ride</a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
          <li><a href="#">Consumo</a></li>
          <li><a href="#">Kilometraje</a></li>
        </ul>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col s12 m12 l12">
          <div class="card-panel">
            <div class="row">
              <form id="distance-form" class="col s12">
                <!--<img class="responsive-img" src="img/pi.jpg">-->
                <div class="row">
                  <div class="input-field col s12">
                    <div class="select-wrapper"><span class="caret">▼</span>
                      <select id="origen" class="initialized" required="">
                        <option value="" disabled>Seleccione Ciudad</option>
                        <option value="actual">su ubicación actual</option>
                        <option value="-33.45694,-70.64827" selected>Santiago</option>
                        <option value="-33.61169,-70.57577">Puente Alto</option>
                        <option value="-23.65236,-70.3954">Antofagasta</option>
                        <option value="-33.02457,-71.55183">Viña del Mar</option>
                        <option value="-33.036,-71.62963">Valparaíso</option>
                        <option value="-36.72494,-73.11684">Talcahuano</option>
                        <option value="-33.59217,-70.6996">San Bernardo</option>
                        <option value="-38.73965,-72.59842">Temuco</option>
                        <option value="-20.21326,-70.15027">Iquique</option>
                        <option value="-36.82699,-73.04977">Concepción</option>
                        <option value="-34.17083,-70.74444">Rancagua</option>
                        <option value="-33.58331,-70.63419">La Pintana</option>
                        <option value="-35.4264,-71.65542">Talca</option>
                        <option value="-18.4746,-70.29792">Arica</option>
                        <option value="-29.95332,-71.33947">Coquimbo</option>
                        <option value="-41.4693,-72.94237">Puerto Montt</option>
                        <option value="-29.90453,-71.24894">La Serena</option>
                        <option value="-36.60664,-72.10344">Chillán</option>
                        <option value="-33.04222,-71.37333">Villa Alemana</option>
                        <option value="-22.45667,-68.92371">Calama</option>
                      </select>
                    </div>
                    <label>Ciudad de Origen</label>
                  </div>                        
                  
                </div>

                <div class="row">
                  <div class="input-field col s12">
                    <div class="select-wrapper"><span class="caret">▼</span>
                      <select id="destino" class="initialized" required="">
                        <option value="" disabled>Seleccione Ciudad</option>
                        <option value="-33.45694,-70.64827">Santiago</option>
                        <option value="-33.61169,-70.57577">Puente Alto</option>
                        <option value="-23.65236,-70.3954">Antofagasta</option>
                        <option value="-33.02457,-71.55183">Viña del Mar</option>
                        <option value="-33.036,-71.62963">Valparaíso</option>
                        <option value="-36.72494,-73.11684">Talcahuano</option>
                        <option value="-33.59217,-70.6996">San Bernardo</option>
                        <option value="-38.73965,-72.59842" selected>Temuco</option>
                        <option value="-20.21326,-70.15027">Iquique</option>
                        <option value="-36.82699,-73.04977">Concepción</option>
                        <option value="-34.17083,-70.74444">Rancagua</option>
                        <option value="-33.58331,-70.63419">La Pintana</option>
                        <option value="-35.4264,-71.65542">Talca</option>
                        <option value="-18.4746,-70.29792">Arica</option>
                        <option value="-29.95332,-71.33947">Coquimbo</option>
                        <option value="-41.4693,-72.94237">Puerto Montt</option>
                        <option value="-29.90453,-71.24894">La Serena</option>
                        <option value="-36.60664,-72.10344">Chillán</option>
                        <option value="-33.04222,-71.37333">Villa Alemana</option>
                        <option value="-22.45667,-68.92371">Calama</option>
                      </select>
                    </div>
                    <label>Ciudad de Destino</label>
                  </div>                        
                  
                </div>

                <div class="row">
                  <div class="input-field col s12">
                    <div class="select-wrapper"><span class="caret">▼</span>
                      <select id="vehicle" class="initialized" required="">
                        <option value="" disabled>Seleccione Vehículo</option>
                        <option value="veloster" selected>Hyundai Veloster FS</option>
                        <option value="lancer">Mitsubishi Lancer</option>
                        <option value="impreza">Subaru Impreza WRX</option>
                        <option value="gol">Volkswagen Gol</option>
                        <option value=rio3">Kia Rio 3</option>
                      </select>
                    </div>
                    <label>Vehículo</label>
                  </div>                        
                  
                </div>

                <div class="row">
                  <div class="input-field col s12">
                    <button class="btn cyan waves-effect waves-light right" type="submit" name="action">Submit
                      <i class="mdi-content-send right"></i>
                    </button>
                  </div>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="modal1" class="modal">
      <div class="modal-content">
        <h4>Cálculo del Viaje</h4>
        <div class="row">
          <div class="col m8">
            <p id="trip_resume">A bunch of text</p>
          </div>
          <div class="col m4">
            <img src="img/td.jpg" alt="">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
      </div>
    </div>
    <!--JavaScript at end of body for optimized loading-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      const QS = (s)=>document.querySelector(s);
      const QSA = (s)=>document.querySelectorAll(s);

      const modal = M.Modal.init(document.getElementById('modal1'), {});
      //modal.open();
      (function init() {
        $('select').formSelect();
        $("select[required]").css({
          display: "inline",
          height: 0,
          padding: 0,
          width: 0
        });
      })();
      
      class Vehiculo {
        get_consumo(kms) {
          throw new Error('Not implemented');
        }
      }
      class Veloster extends Vehiculo {
        get_consumo(kms) {
          return kms / 17.3;
        }
      }
      class Lancer extends Vehiculo {
        get_consumo(kms) {
          return kms / 15.7;
        }
      }
      class Impreza extends Vehiculo {
        get_consumo(kms) {
          return kms / 14.1;
        }
      }
      class Gol extends Vehiculo {
        get_consumo(kms) {
          return kms / 18;
        }
      }
      class Rio3 extends Vehiculo {
        get_consumo(kms) {
          return kms / 22.5;
        }
      }

      const fetch_data = function(origen_coords, destino_coords, origen_name, destino_name, vehicle) {
        fetch(`https://maps.googleapis.com/maps/api/distancematrix/json?origins=${origen_coords}&destinations=${destino_coords}&key=AIzaSyAlDSRLGoUqLzoFZQlR7wvyRoNdsufoQls`)
          .then(
            datos => datos.json()
          )
          .then(function(datos) {
            // Acá recién puedo ocupar los datos
            const consumo = vehicle.get_consumo(datos.rows[0].elements[0].distance.value / 1000);
            const distance = datos.rows[0].elements[0].distance.text;
            const duration = datos.rows[0].elements[0].duration.text;
            document.getElementById('trip_resume').innerHTML = `Conducir desde ${origen_name} hasta ${destino_name} le tomará ${duration}
              recorrer los ${distance}, consumiendo un total de ${consumo.toFixed(2)} litros de bencina`;
            modal.open();
          })
          .catch(function(error) {
            alert(`Error: ${error}`);
          });
      }
      
      document.getElementById('distance-form').addEventListener('submit', function(ev) {
        ev.preventDefault();
        
        const origen = document.getElementById('origen');
        const destino = document.getElementById('destino');

        const vehicle_name = document.getElementById('vehicle').value;
        const origen_coords = origen.value;
        const origen_name = origen.options[origen.selectedIndex].innerHTML;
        const destino_coords = destino.value;
        const destino_name = destino.options[destino.selectedIndex].innerHTML;

        let vehicle;
        if (vehicle_name == 'veloster') { vehicle = new Veloster(); }
        else if (vehicle_name == 'lancer') { vehicle = new Lancer(); }
        else if (vehicle_name == 'impreza') { vehicle = new Impreza(); }
        else if (vehicle_name == 'gol') { vehicle = new Gol(); }
        else { vehicle = new Rio3(); }

        if (origen_coords == 'actual') {
          navigator.geolocation.getCurrentPosition(pos => {
            fetch_data(`${pos.coords.latitude},${pos.coords.longitude}`, destino_coords, origen_name, destino_name, vehicle);
          });
        } else {
          fetch_data(origen_coords, destino_coords, origen_name, destino_name, vehicle);
        }
      });

    </script>
  </body>
</html>